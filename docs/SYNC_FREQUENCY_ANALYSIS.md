# ðŸ“Š Protalk è¯„è®ºæŠ“å–å’ŒåŒæ­¥é¢‘çŽ‡åˆ†æž

## ðŸ“‹ å½“å‰åŒæ­¥é…ç½®

### 1. **å®šæ—¶åŒæ­¥é¢‘çŽ‡**

#### ä»£ç å®žçŽ° (src/index.ts)
```typescript
const cronExpression = '*/10 * * * *'; // æ¯10åˆ†é’ŸåŒæ­¥ä¸€æ¬¡ï¼ˆç¨å¾®æ”¾å®½é—´éš”ï¼‰
```

#### é…ç½®æ–‡ä»¶ (config.json)
```json
{
  "sync": {
    "interval": "0 * * * *",    // é…ç½®æ–‡ä»¶ä¸­æ˜¯æ¯å°æ—¶ï¼Œä½†ä»£ç ä¸­ç¡¬ç¼–ç ä¸º10åˆ†é’Ÿ
    "batchSize": 100,
    "maxRetries": 3,
    "retryDelay": 1000
  }
}
```

**âš ï¸ æ³¨æ„**: å­˜åœ¨é…ç½®ä¸ä¸€è‡´çš„é—®é¢˜ï¼

### 2. **å®žé™…è¿è¡Œé¢‘çŽ‡**

| é…ç½®æ¥æº | Cronè¡¨è¾¾å¼ | é¢‘çŽ‡ | ç”Ÿæ•ˆçŠ¶æ€ |
|----------|------------|------|----------|
| **src/index.ts** | `*/10 * * * *` | **æ¯10åˆ†é’Ÿ** | âœ… **å®žé™…ç”Ÿæ•ˆ** |
| **config.json** | `0 * * * *` | æ¯1å°æ—¶ | âŒ æœªä½¿ç”¨ |

## ðŸ” åŒæ­¥æµç¨‹åˆ†æž

### åŒæ­¥è§¦å‘æ–¹å¼

#### 1. **è‡ªåŠ¨å®šæ—¶åŒæ­¥**
```typescript
// æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
cron.schedule('*/10 * * * *', async () => {
  for (const store of appConfig.stores) {
    if (store.enabled) {
      const result = await reviewSyncService.syncReviews(store.appId);
    }
  }
});
```

#### 2. **æ‰‹åŠ¨APIè§¦å‘**
```bash
# å•ä¸ªåº”ç”¨åŒæ­¥
GET /api/sync-reviews?appId=1077776989

# æ‰¹é‡åº”ç”¨åŒæ­¥  
POST /api/sync-reviews
{
  "appIds": ["1077776989", "å¦ä¸€ä¸ªåº”ç”¨ID"]
}

# é€šè¿‡é£žä¹¦æœåŠ¡è§¦å‘
POST /api/sync
```

### åŒæ­¥æ‰§è¡Œè¯¦æƒ…

#### å•æ¬¡åŒæ­¥æµç¨‹
```typescript
1. èŽ·å–å·²å­˜åœ¨çš„è¯„è®ºID (æ•°æ®åº“æŸ¥è¯¢)
2. è°ƒç”¨App Store Connect APIèŽ·å–æœ€æ–°è¯„è®º
3. æ•°æ®å¤„ç†å’ŒåŽ»é‡ (DataProcessor.processReviewBatch)
4. æ›´æ–°æ•°æ®åº“ (upsertReviews)
5. æŽ¨é€æ–°è¯„è®ºåˆ°é£žä¹¦ (pushBatchUpdates)
6. æŽ¨é€æ›´æ–°è¯„è®ºåˆ°é£žä¹¦ (pushBatchUpdates)
7. æ›´æ–°åŒæ­¥æ—¶é—´ (updateSyncTime)
```

#### æ‰¹é‡å¤„ç†é…ç½®
- **batchSize**: 100æ¡è¯„è®º/æ‰¹æ¬¡
- **maxRetries**: å¤±è´¥é‡è¯•3æ¬¡
- **retryDelay**: é‡è¯•é—´éš”1ç§’
- **API timeout**: 30ç§’

## ðŸ“ˆ åŒæ­¥é¢‘çŽ‡å¯¹æ¯”åˆ†æž

### å½“å‰é…ç½®: æ¯10åˆ†é’Ÿ

#### âœ… ä¼˜ç‚¹
- **å®žæ—¶æ€§å¥½**: æ–°è¯„è®ºèƒ½åœ¨10åˆ†é’Ÿå†…è¢«å‘çŽ°
- **å“åº”åŠæ—¶**: ç”¨æˆ·ä½“éªŒè¾ƒå¥½
- **æ•°æ®æ–°é²œ**: è¯„è®ºæ•°æ®ä¿æŒè¾ƒæ–°çŠ¶æ€

#### âš ï¸ æ½œåœ¨é—®é¢˜
- **APIè°ƒç”¨é¢‘ç¹**: æ¯å¤©144æ¬¡è°ƒç”¨
- **èµ„æºæ¶ˆè€—**: è¾ƒé«˜çš„è®¡ç®—å’Œç½‘ç»œèµ„æºä½¿ç”¨
- **å¯èƒ½è§¦å‘é™æµ**: App Store APIæœ‰é€ŸçŽ‡é™åˆ¶

### å¸¸è§åŒæ­¥é¢‘çŽ‡å»ºè®®

| é¢‘çŽ‡ | Cronè¡¨è¾¾å¼ | é€‚ç”¨åœºæ™¯ | APIè°ƒç”¨æ¬¡æ•°/å¤© |
|------|------------|----------|----------------|
| **æ¯5åˆ†é’Ÿ** | `*/5 * * * *` | é«˜å®žæ—¶æ€§è¦æ±‚ | 288æ¬¡ |
| **æ¯10åˆ†é’Ÿ** | `*/10 * * * *` | **å½“å‰é…ç½®** | **144æ¬¡** |
| **æ¯15åˆ†é’Ÿ** | `*/15 * * * *` | å¹³è¡¡æ€§èƒ½å’Œå®žæ—¶æ€§ | 96æ¬¡ |
| **æ¯30åˆ†é’Ÿ** | `*/30 * * * *` | ä¸­ç­‰å®žæ—¶æ€§è¦æ±‚ | 48æ¬¡ |
| **æ¯1å°æ—¶** | `0 * * * *` | ä½Žå®žæ—¶æ€§è¦æ±‚ | 24æ¬¡ |

## ðŸŽ¯ ä¼˜åŒ–å»ºè®®

### 1. **é…ç½®ç»Ÿä¸€åŒ–**

#### é—®é¢˜
- ä»£ç ç¡¬ç¼–ç ä¸Žé…ç½®æ–‡ä»¶ä¸ä¸€è‡´
- æ— æ³•åŠ¨æ€è°ƒæ•´åŒæ­¥é¢‘çŽ‡

#### è§£å†³æ–¹æ¡ˆ
```typescript
// ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„interval
const cronExpression = appConfig.sync.interval || '*/10 * * * *';
cron.schedule(cronExpression, async () => {
  // åŒæ­¥é€»è¾‘
});
```

### 2. **æ™ºèƒ½è°ƒé¢‘ç­–ç•¥**

#### åŠ¨æ€è°ƒé¢‘
```typescript
// æ ¹æ®è¯„è®ºæ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´
if (newReviewsCount > 10) {
  // é«˜æ´»è·ƒæœŸï¼š5åˆ†é’ŸåŒæ­¥
  cronExpression = '*/5 * * * *';
} else if (newReviewsCount > 0) {
  // ä¸­ç­‰æ´»è·ƒæœŸï¼š10åˆ†é’ŸåŒæ­¥
  cronExpression = '*/10 * * * *';
} else {
  // ä½Žæ´»è·ƒæœŸï¼š30åˆ†é’ŸåŒæ­¥
  cronExpression = '*/30 * * * *';
}
```

#### æ—¶æ®µä¼˜åŒ–
```typescript
// å·¥ä½œæ—¶é—´é¢‘ç¹åŒæ­¥ï¼Œéžå·¥ä½œæ—¶é—´é™é¢‘
const hour = new Date().getHours();
if (hour >= 9 && hour <= 21) {
  cronExpression = '*/10 * * * *';  // å·¥ä½œæ—¶é—´10åˆ†é’Ÿ
} else {
  cronExpression = '*/30 * * * *';  // éžå·¥ä½œæ—¶é—´30åˆ†é’Ÿ
}
```

### 3. **å¢žé‡åŒæ­¥ä¼˜åŒ–**

#### å½“å‰å®žçŽ°
```typescript
// æ¯æ¬¡éƒ½èŽ·å–å…¨é‡è¯„è®ºï¼Œç„¶åŽåŽ»é‡
const apiReviews = await this.fetcher.syncReviews(appId);
const processed = DataProcessor.processReviewBatch(apiReviews, existingReviewIds);
```

#### ä¼˜åŒ–å»ºè®®
```typescript
// åŸºäºŽæ—¶é—´æˆ³çš„å¢žé‡åŒæ­¥
const lastSyncTime = await this.db.getLastSyncTime(appId);
const newReviews = await this.fetcher.syncReviewsSince(appId, lastSyncTime);
```

### 4. **èµ„æºä¼˜åŒ–**

#### APIè°ƒç”¨ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: å¯¹äºŽæœªå˜åŒ–çš„è¯„è®ºä½¿ç”¨ç¼“å­˜
- **æ‰¹é‡å¤„ç†**: ä¼˜åŒ–æ•°æ®åº“æ‰¹é‡æ“ä½œ
- **è¿žæŽ¥æ± **: å¤ç”¨HTTPè¿žæŽ¥

#### é”™è¯¯å¤„ç†
- **æŒ‡æ•°é€€é¿**: å¤±è´¥åŽé€æ¸å¢žåŠ é‡è¯•é—´éš”
- **ç†”æ–­æœºåˆ¶**: APIæŒç»­å¤±è´¥æ—¶æš‚åœåŒæ­¥
- **é™çº§ç­–ç•¥**: APIä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

## ðŸ“Š å½“å‰æ€§èƒ½æŒ‡æ ‡

### åŒæ­¥æ•ˆçŽ‡
```bash
# æŸ¥çœ‹æœ€è¿‘åŒæ­¥æ—¥å¿—
tail -f logs/combined.log | grep "å®šæ—¶åŒæ­¥"

# åŒæ­¥æ€§èƒ½ç»Ÿè®¡
curl http://localhost:3000/api/sync-status/1077776989
```

### å…³é”®æŒ‡æ ‡
- **åŒæ­¥å»¶è¿Ÿ**: è¯„è®ºå‘å¸ƒåˆ°ç³»ç»Ÿå‘çŽ°çš„æ—¶é—´é—´éš”
- **APIæˆåŠŸçŽ‡**: App Store Connect APIè°ƒç”¨æˆåŠŸçŽ‡
- **æ•°æ®å®Œæ•´æ€§**: æ˜¯å¦é—æ¼è¯„è®º
- **æŽ¨é€åŠæ—¶æ€§**: æ–°è¯„è®ºæŽ¨é€åˆ°é£žä¹¦çš„æ—¶é—´

## ðŸ”§ é…ç½®ä¿®æ”¹å»ºè®®

### ç«‹å³ä¼˜åŒ–

#### 1. ä¿®å¤é…ç½®ä¸ä¸€è‡´
```typescript
// src/index.ts ä¿®æ”¹
const cronExpression = appConfig.sync.interval || '*/10 * * * *';
```

#### 2. æ·»åŠ çŽ¯å¢ƒå˜é‡æŽ§åˆ¶
```bash
# æ”¯æŒçŽ¯å¢ƒå˜é‡è¦†ç›–
SYNC_INTERVAL="*/15 * * * *"  # 15åˆ†é’ŸåŒæ­¥
SYNC_BATCH_SIZE=50           # æ‰¹æ¬¡å¤§å°
SYNC_MAX_RETRIES=5           # é‡è¯•æ¬¡æ•°
```

### é•¿æœŸä¼˜åŒ–

#### 1. æ™ºèƒ½åŒæ­¥
- åŸºäºŽåº”ç”¨æ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´
- å·¥ä½œæ—¶é—´å’Œéžå·¥ä½œæ—¶é—´åŒºåˆ«å¯¹å¾…
- æ ¹æ®APIé™åˆ¶è‡ªåŠ¨è°ƒèŠ‚

#### 2. ç›‘æŽ§å‘Šè­¦
- åŒæ­¥å¤±è´¥çŽ‡ç›‘æŽ§
- APIè°ƒç”¨é¢‘çŽ‡ç›‘æŽ§
- å»¶è¿Ÿæ—¶é—´ç›‘æŽ§

## ðŸ“‹ æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… **åŒæ­¥é¢‘çŽ‡**: æ¯10åˆ†é’Ÿï¼Œå®žæ—¶æ€§è¾ƒå¥½
- âš ï¸ **é…ç½®é—®é¢˜**: ä»£ç ä¸Žé…ç½®æ–‡ä»¶ä¸ä¸€è‡´
- âœ… **åŠŸèƒ½å®Œæ•´**: æ”¯æŒæ‰‹åŠ¨å’Œè‡ªåŠ¨åŒæ­¥
- âš ï¸ **ä¼˜åŒ–ç©ºé—´**: å¯ä»¥æ›´æ™ºèƒ½åŒ–

### å»ºè®®è¡ŒåŠ¨
1. **ç«‹å³**: ä¿®å¤é…ç½®ä¸ä¸€è‡´é—®é¢˜
2. **çŸ­æœŸ**: æ·»åŠ çŽ¯å¢ƒå˜é‡æŽ§åˆ¶
3. **ä¸­æœŸ**: å®žçŽ°æ™ºèƒ½è°ƒé¢‘ç­–ç•¥
4. **é•¿æœŸ**: å»ºç«‹å®Œæ•´ç›‘æŽ§ä½“ç³»

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åŽæ›´æ–°**: 2025å¹´8æœˆ28æ—¥  
**å½“å‰åŒæ­¥é¢‘çŽ‡**: æ¯10åˆ†é’Ÿ (`*/10 * * * *`)  
**é…ç½®æ–‡ä»¶**: config.json (æœªç”Ÿæ•ˆ)  
**å®žé™…é…ç½®**: src/index.ts (ç¡¬ç¼–ç )
