/**
 * App Storeè¯„è®ºå¡ç‰‡æ¨¡æ¿
 * åŸºäºé£ä¹¦å¡ç‰‡v2ç»„ä»¶ç³»ç»Ÿçš„ç°ä»£åŒ–è®¾è®¡
 */

import { 
  FeishuCardV2, 
  createCardBuilder,
  CardHeader 
} from './feishu-card-v2-builder';
import logger from './logger';

// ä½¿ç”¨å…¨å±€AppReviewç±»å‹å®šä¹‰
import { AppReview } from '../types';

// ================================
// è¯„è®ºå¡ç‰‡æ¨¡æ¿ç±»
// ================================

export class ReviewCardTemplates {
  
  /**
   * åˆ›å»ºæ ‡å‡†è¯„è®ºå¡ç‰‡ï¼ˆv2æ ¼å¼ï¼‰
   */
  static createStandardReviewCard(review: AppReview): FeishuCardV2 {
    const stars = 'â­'.repeat(Math.max(0, Math.min(5, review.rating || 0)));
    const storeIcon = review.store_type === 'ios' ? 'ğŸ“±' : 'ğŸ¤–';
    const template = ReviewCardTemplates.getRatingTemplate(review.rating);
    
    const builder = createCardBuilder()
      .setConfig({ 
        wide_screen_mode: true, 
        enable_forward: true,
        style: { theme: 'default' }
      })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: `${storeIcon} ${review.app_name} - æ–°è¯„è®ºé€šçŸ¥` 
        },
        ...(review.title && {
          subtitle: { 
            tag: 'plain_text', 
            content: review.title 
          }
        }),
        template: template || 'default'
      });

    // è¯„åˆ†å’ŒåŸºæœ¬ä¿¡æ¯
    builder.addDiv(undefined, [
      { 
        isShort: true, 
        text: { 
          tag: 'lark_md', 
          content: `**è¯„åˆ†**\n${stars} ${review.rating}/5`,
          text_size: 'medium'
        }
      },
      { 
        isShort: true, 
        text: { 
          tag: 'lark_md', 
          content: `**ç”¨æˆ·**\n${review.reviewerNickname || 'åŒ¿åç”¨æˆ·'}`,
          text_size: 'medium'
        }
      }
    ]);

    // è¯„è®ºå†…å®¹
    if (review.body) {
      builder.addHr()
        .addDiv({
          tag: 'lark_md',
          content: `**è¯„è®ºå†…å®¹**\n${review.body}`,
          text_size: 'normal'
        });
    }

    // é™„åŠ ä¿¡æ¯
    const additionalInfo = ReviewCardTemplates.buildAdditionalInfo(review);
    if (additionalInfo.length > 0) {
      builder.addHr()
        .addDiv(undefined, additionalInfo);
    }

    // å¼€å‘è€…å›å¤
    if (review.developer_response) {
      builder.addHr()
        .addNote([
          { type: 'text', content: 'ğŸ‘¨â€ğŸ’» å¼€å‘è€…å›å¤' }
        ])
        .addDiv({
          tag: 'lark_md',
          content: review.developer_response.content,
          text_size: 'small'
        });
    }

    // æ·»åŠ äº¤äº’å›å¤åŒºåŸŸ
    if (!review.developer_response) {
      builder.addHr()
        .addNote([
          { type: 'text', content: 'ğŸ’¬ å¼€å‘è€…å›å¤' }
        ])
        .addInput('reply_content', {
          placeholder: 'åœ¨æ­¤è¾“å…¥æ‚¨çš„å›å¤å†…å®¹...',
          required: true,
          maxLength: 1000,
          width: 'fill'
        })
        .addActionGroup([
          {
            text: 'ğŸ“¤ æäº¤å›å¤',
            type: 'primary',
            actionType: 'request',
            value: {
              action: 'submit_reply',
              review_id: review.reviewId,
              app_id: review.appId
            }
          },
          {
            text: 'ğŸ“Š æŸ¥çœ‹è¯¦æƒ…',
            type: 'default',
            actionType: 'link',
            url: review.url || '#'
          }
        ], 'flow');
    } else {
      // å·²å›å¤çŠ¶æ€ï¼Œæ˜¾ç¤ºæ›´æ–°å’ŒæŸ¥çœ‹æŒ‰é’®
      builder.addHr()
        .addActionGroup([
          {
            text: 'ğŸ”„ æ›´æ–°å›å¤',
            type: 'default',
            actionType: 'request',
            value: {
              action: 'update_reply',
              review_id: review.id,
              app_id: review.app_id
            }
          },
          {
            text: 'ğŸ“Š æŸ¥çœ‹è¯¦æƒ…',
            type: 'default',
            actionType: 'link',
            url: review.url || '#'
          }
        ], 'flow');
    }

    return builder.build();
  }

  /**
   * åˆ›å»ºç´§å‡‘å‹è¯„è®ºå¡ç‰‡
   */
  static createCompactReviewCard(review: AppReview): FeishuCardV2 {
    const stars = 'â­'.repeat(Math.max(0, Math.min(5, review.rating || 0)));
    const storeIcon = review.store_type === 'ios' ? 'ğŸ“±' : 'ğŸ¤–';
    const template = ReviewCardTemplates.getRatingTemplate(review.rating);

    return createCardBuilder()
      .setConfig({ 
        wide_screen_mode: false,
        style: { header_style: 'compact' }
      })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: `${storeIcon} ${review.app_name}`,
          lines: 1
        },
        template: template || 'default'
      })
      .addColumnSet([
        {
          width: 'weighted',
          weight: 3,
          elements: [
            {
              type: 'div',
              content: {
                tag: 'lark_md',
                content: `${stars} **${review.author || 'åŒ¿å'}**\n${review.content.substring(0, 100)}${review.content.length > 100 ? '...' : ''}`,
                text_size: 'small'
              }
            }
          ]
        },
        {
          width: 'weighted',
          weight: 1,
          elements: [
            {
              type: 'button',
              content: {
                text: 'æŸ¥çœ‹',
                type: 'primary',
                actionType: 'request',
                value: { action: 'view', review_id: review.id }
              }
            }
          ]
        }
      ])
      .build();
  }

  /**
   * åˆ›å»ºè¯„è®ºæ‘˜è¦å¡ç‰‡
   */
  static createReviewSummaryCard(
    appName: string,
    reviews: AppReview[],
    stats: {
      total: number;
      averageRating: number;
      ratingDistribution: { [key: number]: number };
    }
  ): FeishuCardV2 {
    const avgStars = 'â­'.repeat(Math.round(stats.averageRating));
    
    const builder = createCardBuilder()
      .setConfig({ wide_screen_mode: true, enable_forward: true })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: `ğŸ“Š ${appName} - è¯„è®ºæ‘˜è¦æŠ¥å‘Š` 
        },
        template: 'blue'
      });

    // ç»Ÿè®¡ä¿¡æ¯
    builder.addDiv(undefined, [
      { 
        isShort: true, 
        text: `**æ€»è¯„è®ºæ•°**\n${stats.total}` 
      },
      { 
        isShort: true, 
        text: `**å¹³å‡è¯„åˆ†**\n${avgStars} ${stats.averageRating.toFixed(1)}/5` 
      }
    ]);

    // è¯„åˆ†åˆ†å¸ƒ
    builder.addHr()
      .addDiv('**è¯„åˆ†åˆ†å¸ƒ**');

    Object.entries(stats.ratingDistribution)
      .sort(([a], [b]) => Number(b) - Number(a))
      .forEach(([rating, count]) => {
        const percentage = ((count / stats.total) * 100).toFixed(1);
        const stars = 'â­'.repeat(Number(rating));
        builder.addDiv(`${stars} ${rating}æ˜Ÿ: ${count}æ¡ (${percentage}%)`);
      });

    // æœ€æ–°è¯„è®ºé¢„è§ˆ
    if (reviews.length > 0) {
      builder.addHr()
        .addDiv('**æœ€æ–°è¯„è®º**');

      reviews.slice(0, 3).forEach((review, index) => {
        const stars = 'â­'.repeat(review.rating);
        const preview = review.content.substring(0, 80) + (review.content.length > 80 ? '...' : '');
        
        builder.addDiv(undefined, [
          { 
            isShort: false, 
            text: `${index + 1}. ${stars} **${review.author || 'åŒ¿å'}**\n${preview}` 
          }
        ]);
      });
    }

    // æ“ä½œæŒ‰é’®
    builder.addHr()
      .addActionGroup([
        {
          text: 'æŸ¥çœ‹å…¨éƒ¨è¯„è®º',
          type: 'primary',
          actionType: 'request',
          value: { action: 'view_all_reviews', app_name: appName }
        },
        {
          text: 'å¯¼å‡ºæŠ¥å‘Š',
          type: 'default',
          actionType: 'request',
          value: { action: 'export_report', app_name: appName }
        }
      ]);

    return builder.build();
  }

  /**
   * åˆ›å»ºè¯„è®ºå›å¤å¡ç‰‡
   */
  static createReplyCard(
    originalReview: AppReview,
    replyContent: string,
    replyAuthor: string = 'å¼€å‘å›¢é˜Ÿ'
  ): FeishuCardV2 {
    const stars = 'â­'.repeat(originalReview.rating);
    
    return createCardBuilder()
      .setConfig({ wide_screen_mode: true })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: 'ğŸ’¬ è¯„è®ºå›å¤é€šçŸ¥' 
        },
        template: 'green'
      })
      .addDiv('**åŸå§‹è¯„è®º**')
      .addDiv(undefined, [
        { isShort: true, text: `${stars} **${originalReview.author}**` },
        { isShort: true, text: originalReview.title || 'æ— æ ‡é¢˜' }
      ])
      .addDiv(`> ${originalReview.content}`)
      .addHr()
      .addDiv('**å¼€å‘è€…å›å¤**')
      .addDiv({
        tag: 'lark_md',
        content: `**${replyAuthor}**: ${replyContent}`,
        text_size: 'normal'
      })
      .addHr()
      .addActionGroup([
        {
          text: 'æŸ¥çœ‹å®Œæ•´å¯¹è¯',
          type: 'primary',
          actionType: 'request',
          value: { action: 'view_conversation', review_id: originalReview.id }
        }
      ])
      .build();
  }

  /**
   * åˆ›å»ºè¯„è®ºæé†’å¡ç‰‡
   */
  static createReminderCard(
    pendingCount: number,
    urgentReviews: AppReview[]
  ): FeishuCardV2 {
    const builder = createCardBuilder()
      .setConfig({ wide_screen_mode: true })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: 'ğŸ”” è¯„è®ºå¤„ç†æé†’' 
        },
        template: 'orange'
      })
      .addDiv(`æ‚¨æœ‰ **${pendingCount}** æ¡è¯„è®ºå¾…å¤„ç†`);

    if (urgentReviews.length > 0) {
      builder.addHr()
        .addDiv('**éœ€è¦ä¼˜å…ˆå¤„ç†çš„ä½åˆ†è¯„è®º:**');

      urgentReviews.forEach((review, index) => {
        const stars = 'â­'.repeat(review.rating);
        builder.addDiv(`${index + 1}. ${stars} ${review.author || 'åŒ¿å'}: ${review.content.substring(0, 60)}...`);
      });
    }

    builder.addHr()
      .addActionGroup([
        {
          text: 'ç«‹å³å¤„ç†',
          type: 'primary',
          actionType: 'request',
          value: { action: 'process_reviews' }
        },
        {
          text: 'ç¨åæé†’',
          type: 'default',
          actionType: 'request',
          value: { action: 'snooze_reminder', duration: 3600 }
        }
      ]);

    return builder.build();
  }

  // ================================
  // è¾…åŠ©æ–¹æ³•
  // ================================

  /**
   * åˆ›å»ºå›å¤æˆåŠŸçŠ¶æ€å¡ç‰‡
   */
  static createReplySuccessCard(reviewId: string, replyContent: string): FeishuCardV2 {
    return createCardBuilder()
      .setConfig({ 
        wide_screen_mode: true
      })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: 'âœ… å›å¤æäº¤æˆåŠŸ' 
        },
        template: 'green'
      })
      .addDiv({
        tag: 'lark_md',
        content: `**å›å¤å†…å®¹å·²æˆåŠŸæäº¤**\n\n${replyContent}\n\nå›å¤å°†åœ¨App Storeå®¡æ ¸åå¯¹ç”¨æˆ·å¯è§ã€‚`,
        text_size: 'normal'
      })
      .addNote([
        { type: 'text', content: `ğŸ“ è¯„è®ºID: ${reviewId}` },
        { type: 'text', content: `â° æäº¤æ—¶é—´: ${new Date().toLocaleString('zh-CN')}` }
      ])
      .build();
  }

  /**
   * åˆ›å»ºå›å¤å¤±è´¥çŠ¶æ€å¡ç‰‡
   */
  static createReplyErrorCard(reviewId: string, error: string): FeishuCardV2 {
    return createCardBuilder()
      .setConfig({ 
        wide_screen_mode: true
      })
      .setHeader({
        title: { 
          tag: 'plain_text', 
          content: 'âŒ å›å¤æäº¤å¤±è´¥' 
        },
        template: 'red'
      })
      .addDiv({
        tag: 'lark_md',
        content: `**å›å¤æäº¤é‡åˆ°é—®é¢˜**\n\né”™è¯¯ä¿¡æ¯ï¼š${error}\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`,
        text_size: 'normal'
      })
      .addNote([
        { type: 'text', content: `ğŸ“ è¯„è®ºID: ${reviewId}` },
        { type: 'text', content: `â° å¤±è´¥æ—¶é—´: ${new Date().toLocaleString('zh-CN')}` }
      ])
      .addActionGroup([
        {
          text: 'ğŸ”„ é‡è¯•',
          type: 'primary',
          actionType: 'request',
          value: {
            action: 'retry_reply',
            review_id: reviewId
          }
        }
      ])
      .build();
  }

  /**
   * æ ¹æ®è¯„åˆ†è·å–æ¨¡æ¿é¢œè‰²
   */
  private static getRatingTemplate(rating: number): CardHeader['template'] {
    if (rating >= 4) return 'green';
    if (rating >= 3) return 'yellow';
    if (rating >= 2) return 'orange';
    return 'red';
  }

  /**
   * æ„å»ºé™„åŠ ä¿¡æ¯å­—æ®µ
   */
  private static buildAdditionalInfo(review: AppReview): Array<{ isShort: boolean; text: string }> {
    const fields: Array<{ isShort: boolean; text: string }> = [];

    if (review.version) {
      fields.push({ 
        isShort: true, 
        text: `**ç‰ˆæœ¬**\n${review.version}` 
      });
    }

    if (review.date) {
      fields.push({ 
        isShort: true, 
        text: `**æ—¥æœŸ**\n${new Date(review.date).toLocaleDateString('zh-CN')}` 
      });
    }

    if (review.country) {
      fields.push({ 
        isShort: true, 
        text: `**åœ°åŒº**\n${review.country}` 
      });
    }

    if (review.verified_purchase) {
      fields.push({ 
        isShort: true, 
        text: `**è´­ä¹°éªŒè¯**\nâœ… å·²éªŒè¯` 
      });
    }

    if (review.helpful_count && review.helpful_count > 0) {
      fields.push({ 
        isShort: true, 
        text: `**æœ‰ç”¨**\nğŸ‘ ${review.helpful_count}` 
      });
    }

    return fields;
  }

  /**
   * éªŒè¯è¯„è®ºæ•°æ®å®Œæ•´æ€§
   */
  static validateReview(review: AppReview): { valid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!review.id) errors.push('ç¼ºå°‘è¯„è®ºID');
    if (!review.app_name) errors.push('ç¼ºå°‘åº”ç”¨åç§°');
    if (!review.content) errors.push('ç¼ºå°‘è¯„è®ºå†…å®¹');
    if (typeof review.rating !== 'number' || review.rating < 1 || review.rating > 5) {
      errors.push('è¯„åˆ†å¿…é¡»æ˜¯1-5ä¹‹é—´çš„æ•°å­—');
    }
    if (!['ios', 'android'].includes(review.store_type)) {
      errors.push('å•†åº—ç±»å‹å¿…é¡»æ˜¯iosæˆ–android');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }

  /**
   * è®°å½•å¡ç‰‡åˆ›å»ºæ—¥å¿—
   */
  static logCardCreation(cardType: string, reviewId: string) {
    logger.info('åˆ›å»ºè¯„è®ºå¡ç‰‡', { 
      cardType, 
      reviewId, 
      timestamp: new Date().toISOString() 
    });
  }
}

// ================================
// ä¾¿æ·å¯¼å‡ºå‡½æ•°
// ================================

/**
 * åˆ›å»ºæ ‡å‡†è¯„è®ºé€šçŸ¥å¡ç‰‡
 */
export function createReviewCard(review: AppReview): FeishuCardV2 {
  const validation = ReviewCardTemplates.validateReview(review);
  if (!validation.valid) {
    logger.error('è¯„è®ºæ•°æ®éªŒè¯å¤±è´¥', { errors: validation.errors, reviewId: review.id });
    throw new Error(`è¯„è®ºæ•°æ®æ— æ•ˆ: ${validation.errors.join(', ')}`);
  }

  ReviewCardTemplates.logCardCreation('standard', review.id);
  return ReviewCardTemplates.createStandardReviewCard(review);
}

/**
 * åˆ›å»ºç´§å‡‘è¯„è®ºå¡ç‰‡
 */
export function createCompactReviewCard(review: AppReview): FeishuCardV2 {
  const validation = ReviewCardTemplates.validateReview(review);
  if (!validation.valid) {
    logger.error('è¯„è®ºæ•°æ®éªŒè¯å¤±è´¥', { errors: validation.errors, reviewId: review.id });
    throw new Error(`è¯„è®ºæ•°æ®æ— æ•ˆ: ${validation.errors.join(', ')}`);
  }

  ReviewCardTemplates.logCardCreation('compact', review.id);
  return ReviewCardTemplates.createCompactReviewCard(review);
}

export default {
  ReviewCardTemplates,
  createReviewCard,
  createCompactReviewCard
};
