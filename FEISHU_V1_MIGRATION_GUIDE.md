# é£ä¹¦v1 APIè¿ç§»æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä»å½“å‰ç¨³å®šçš„v4 APIç‰ˆæœ¬è¿ç§»åˆ°æœ€æ–°çš„é£ä¹¦v1 APIç‰ˆæœ¬ã€‚æ–°ç‰ˆæœ¬æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ã€æ›´å¥½çš„å®‰å…¨æ€§å’Œæ›´å®Œæ•´çš„APIæ”¯æŒã€‚

## ğŸ¯ v1 APIçš„ä¼˜åŠ¿

### âœ… **åŠŸèƒ½å¢å¼º**
- **å®Œæ•´çš„æ¶ˆæ¯ç±»å‹æ”¯æŒ**: æ–‡æœ¬ã€å¯Œæ–‡æœ¬ã€å›¾ç‰‡ã€äº’åŠ¨å¡ç‰‡
- **é«˜çº§äº’åŠ¨åŠŸèƒ½**: å›å¤æ¶ˆæ¯ã€çº¿ç¨‹ç®¡ç†
- **æ‰¹é‡æ“ä½œ**: è·å–æ‰€æœ‰ç¾¤ç»„ã€åˆ†é¡µæŸ¥è¯¢
- **ç»Ÿä¸€çš„é”™è¯¯å¤„ç†**: æ ‡å‡†åŒ–çš„å“åº”æ ¼å¼

### ğŸ” **å®‰å…¨å¢å¼º**
- **ç­¾åéªŒè¯**: æ”¯æŒè¯·æ±‚ç­¾åæ ¡éªŒ
- **ä»¤ç‰Œç®¡ç†**: è‡ªåŠ¨ç®¡ç†è®¿é—®ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸ
- **å‚æ•°éªŒè¯**: ä¸¥æ ¼çš„è¾“å…¥å‚æ•°æ ¡éªŒ

### ğŸ“Š **å¼€å‘ä½“éªŒ**
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- **é”™è¯¯æç¤º**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•å»ºè®®
- **æ–‡æ¡£å®Œå–„**: ç¬¦åˆæœ€æ–°å®˜æ–¹APIæ–‡æ¡£

## ğŸ—‚ï¸ æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ modules/feishu/
â”‚   â”œâ”€â”€ FeishuBot.ts           # åŸv4å®ç°ï¼ˆä¿ç•™ï¼‰
â”‚   â”œâ”€â”€ FeishuBotV1.ts        # æ–°v1å®ç° â­
â”‚   â””â”€â”€ FeishuBotV2.ts        # æ··åˆå®ç°ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ ReviewSyncService.ts   # åŸæœåŠ¡ï¼ˆå…¼å®¹ï¼‰
â”‚   â””â”€â”€ FeishuServiceV1.ts    # æ–°v1æœåŠ¡ â­
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ feishu-routes-v2.ts   # åŸAPIè·¯ç”±ï¼ˆä¿ç•™ï¼‰
â”‚   â””â”€â”€ feishu-routes-v1.ts   # æ–°v1è·¯ç”± â­
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ feishu-signature.ts   # ç­¾åå·¥å…· â­
â””â”€â”€ index-v1.ts               # v1åº”ç”¨å…¥å£ â­
```

## ğŸ”§ é…ç½®æ›´æ–°

### ç¯å¢ƒå˜é‡æ–°å¢

åœ¨ä½ çš„`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# é£ä¹¦APIé…ç½®
FEISHU_API_VERSION=v1                        # æ–°å¢ï¼šAPIç‰ˆæœ¬é€‰æ‹©
FEISHU_ENABLE_SIGNATURE_VERIFICATION=false  # æ–°å¢ï¼šç­¾åéªŒè¯å¼€å…³

# ç°æœ‰é…ç½®ä¿æŒä¸å˜
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret
FEISHU_VERIFICATION_TOKEN=your_token
FEISHU_ENCRYPT_KEY=your_encrypt_key         # ç­¾åéªŒè¯éœ€è¦
FEISHU_MODE=eventsource
```

### é…ç½®ç±»å‹æ›´æ–°

`src/types/index.ts`ä¸­çš„æ¥å£å·²æ›´æ–°ï¼š

```typescript
feishu: {
  mode?: 'webhook' | 'eventsource';
  apiVersion?: 'v1' | 'v4';              // æ–°å¢
  enableSignatureVerification?: boolean; // æ–°å¢
  appId?: string;
  appSecret?: string;
  verificationToken?: string;
  encryptKey?: string;
  // ... å…¶ä»–é…ç½®
}
```

## ğŸš€ éƒ¨ç½²é€‰é¡¹

### é€‰é¡¹1: æ¸è¿›å¼è¿ç§»ï¼ˆæ¨èï¼‰

ä¿æŒå½“å‰v4ç‰ˆæœ¬è¿è¡Œï¼ŒåŒæ—¶éƒ¨ç½²v1ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼š

```bash
# æµ‹è¯•v1åŠŸèƒ½
npm run test:v1-api

# å¯åŠ¨v1ç‰ˆæœ¬ï¼ˆä¸åŒç«¯å£ï¼‰
PORT=3001 FEISHU_API_VERSION=v1 npm run start:v1
```

### é€‰é¡¹2: å®Œå…¨åˆ‡æ¢

ç›´æ¥åˆ‡æ¢åˆ°v1 APIï¼š

```bash
# æ›´æ–°ç¯å¢ƒå˜é‡
echo "FEISHU_API_VERSION=v1" >> .env

# é‡æ–°ç¼–è¯‘
npm run build

# é‡å¯æœåŠ¡
npm restart
```

### é€‰é¡¹3: æ··åˆæ¨¡å¼

ä½¿ç”¨FeishuBotV2è¿›è¡Œæ··åˆéƒ¨ç½²ï¼Œè‡ªåŠ¨fallbackï¼š

```bash
# ä½¿ç”¨æ··åˆç‰ˆæœ¬
FEISHU_BOT_VERSION=v2 npm start
```

## ğŸ“ ä»£ç è¿ç§»ç¤ºä¾‹

### åŸºç¡€æœåŠ¡æ›¿æ¢

**åŸv4å®ç°**:
```typescript
import { FeishuService } from './services/FeishuService';

const feishuService = new FeishuService({
  appId: config.appId,
  appSecret: config.appSecret,
  // ...
});
```

**æ–°v1å®ç°**:
```typescript
import { FeishuServiceV1 } from './services/FeishuServiceV1';

const feishuService = new FeishuServiceV1({
  appId: config.appId,
  appSecret: config.appSecret,
  enableSignatureVerification: true, // æ–°åŠŸèƒ½
  // ...
});
```

### APIè°ƒç”¨å¯¹æ¯”

**v4 API**:
```typescript
// æœ‰é™çš„æ¶ˆæ¯ç±»å‹æ”¯æŒ
await feishuBot.sendMessage(chatId, content);
await feishuBot.sendCardMessage(chatId, cardData);
```

**v1 API**:
```typescript
// å®Œæ•´çš„æ¶ˆæ¯ç±»å‹æ”¯æŒ
await feishuBot.sendMessage(chatId, content, 'chat_id');
await feishuBot.sendRichTextMessage(chatId, postContent);
await feishuBot.sendCardMessage(chatId, cardData);
await feishuBot.sendImageMessage(chatId, imageKey);
await feishuBot.replyMessage(messageId, content, 'text');
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•

```bash
# è¿è¡Œv1 APIå®Œæ•´æµ‹è¯•
node scripts/test-feishu-v1-api.js
```

é¢„æœŸè¾“å‡ºï¼š
```
âœ… è®¤è¯åŠŸèƒ½æ­£å¸¸
âœ… ç¾¤ç»„è·å–æ­£å¸¸  
âœ… æ–‡æœ¬æ¶ˆæ¯å‘é€æ­£å¸¸
âœ… äº’åŠ¨å¡ç‰‡å‘é€æ­£å¸¸
âœ… App Storeè¯„è®ºå¡ç‰‡æ­£å¸¸
```

### 2. é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•ç”Ÿäº§ç¯å¢ƒå…¼å®¹æ€§
npm run test:integration:v1
```

### 3. æ€§èƒ½æµ‹è¯•

```bash
# å¯¹æ¯”v4å’Œv1æ€§èƒ½
npm run benchmark:api-versions
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§

1. **å‘åå…¼å®¹**: v1å®ç°å®Œå…¨å…¼å®¹ç°æœ‰IPusheræ¥å£
2. **æ•°æ®æ ¼å¼**: å¡ç‰‡å’Œæ¶ˆæ¯æ ¼å¼ä¸v4ä¿æŒä¸€è‡´
3. **é”™è¯¯å¤„ç†**: æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä½†é”™è¯¯ç±»å‹å…¼å®¹

### æ½œåœ¨é—®é¢˜

1. **å¯Œæ–‡æœ¬æ ¼å¼**: v1 APIå¯¹å¯Œæ–‡æœ¬æ ¼å¼è¦æ±‚æ›´ä¸¥æ ¼
2. **ç­¾åéªŒè¯**: å¯ç”¨åéœ€è¦æ­£ç¡®é…ç½®ENCRYPT_KEY
3. **APIé™åˆ¶**: v1 APIå¯èƒ½æœ‰ä¸åŒçš„é¢‘ç‡é™åˆ¶

### å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ°v4ï¼š

```bash
# 1. æ›´æ–°ç¯å¢ƒå˜é‡
sed -i 's/FEISHU_API_VERSION=v1/FEISHU_API_VERSION=v4/' .env

# 2. é‡å¯æœåŠ¡
npm restart

# 3. éªŒè¯åŠŸèƒ½
curl localhost:3000/feishu/test
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åŠŸèƒ½ | v4 API | v1 API | æ”¹è¿› |
|------|--------|--------|------|
| æ–‡æœ¬æ¶ˆæ¯ | âœ… | âœ… | æ›´ä¸¥æ ¼çš„å‚æ•°éªŒè¯ |
| äº’åŠ¨å¡ç‰‡ | âœ… | âœ… | æ›´ä¸°å¯Œçš„å¡ç‰‡å…ƒç´  |
| å¯Œæ–‡æœ¬æ¶ˆæ¯ | âŒ | âœ… | æ–°å¢åŠŸèƒ½ |
| å›¾ç‰‡æ¶ˆæ¯ | âŒ | âœ… | æ–°å¢åŠŸèƒ½ |
| æ¶ˆæ¯å›å¤ | âŒ | âœ… | æ–°å¢åŠŸèƒ½ |
| ç­¾åéªŒè¯ | âŒ | âœ… | å®‰å…¨å¢å¼º |
| é”™è¯¯å¤„ç† | åŸºç¡€ | è¯¦ç»† | è°ƒè¯•ä½“éªŒæå‡ |

## ğŸ¯ è¿ç§»æ—¶é—´è¡¨

### é˜¶æ®µ1: å‡†å¤‡å·¥ä½œï¼ˆ1å¤©ï¼‰
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡
- [ ] è¿è¡Œv1æµ‹è¯•è„šæœ¬
- [ ] æ£€æŸ¥æ—¥å¿—è¾“å‡º

### é˜¶æ®µ2: æµ‹è¯•éƒ¨ç½²ï¼ˆ2-3å¤©ï¼‰
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] åŠŸèƒ½éªŒè¯æµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•

### é˜¶æ®µ3: ç”Ÿäº§åˆ‡æ¢ï¼ˆ1å¤©ï¼‰
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] ç›‘æ§å’ŒéªŒè¯
- [ ] å¤‡ç”¨æ–¹æ¡ˆå‡†å¤‡

### é˜¶æ®µ4: æ¸…ç†ä¼˜åŒ–ï¼ˆ1å¤©ï¼‰
- [ ] ç§»é™¤æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰
- [ ] ä¼˜åŒ–é…ç½®
- [ ] æ–‡æ¡£æ›´æ–°

## ğŸ”— ç›¸å…³èµ„æº

- [é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£](https://open.feishu.cn/document/)
- [v1 APIæ¶ˆæ¯æ¥å£](https://open.feishu.cn/document/server-docs/im-v1/message/intro)
- [äº’åŠ¨å¡ç‰‡å¼€å‘æŒ‡å—](https://open.feishu.cn/document/develop-a-card-interactive-bot/introduction)
- [ç­¾åéªŒè¯è¯´æ˜](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN)

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é€æ­¥è¿ç§»**: å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ‰€æœ‰åŠŸèƒ½
2. **ç›‘æ§æ—¥å¿—**: å¯†åˆ‡å…³æ³¨è¿ç§»åçš„é”™è¯¯æ—¥å¿—
3. **å¤‡ä»½é…ç½®**: ä¿ç•™v4é…ç½®ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
4. **æ€§èƒ½ç›‘æ§**: ç›‘æ§APIå“åº”æ—¶é—´å’ŒæˆåŠŸç‡
5. **ç”¨æˆ·åé¦ˆ**: æ”¶é›†å®é™…ä½¿ç”¨ä¸­çš„é—®é¢˜åé¦ˆ

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: v1 APIè¿”å›400é”™è¯¯ï¼Ÿ**
A: æ£€æŸ¥receive_id_typeå‚æ•°æ˜¯å¦æ­£ç¡®è®¾ç½®

**Q: å¯Œæ–‡æœ¬æ¶ˆæ¯å‘é€å¤±è´¥ï¼Ÿ**  
A: éªŒè¯contentæ ¼å¼æ˜¯å¦ç¬¦åˆé£ä¹¦æ–‡æ¡£è§„èŒƒ

**Q: ç­¾åéªŒè¯å¤±è´¥ï¼Ÿ**
A: ç¡®è®¤ENCRYPT_KEYé…ç½®æ­£ç¡®ä¸”ä¸é£ä¹¦åå°ä¸€è‡´

### è°ƒè¯•æ­¥éª¤

1. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
2. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŸºç¡€åŠŸèƒ½
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
4. å¯¹ç…§å®˜æ–¹æ–‡æ¡£éªŒè¯å‚æ•°æ ¼å¼
5. è”ç³»é£ä¹¦æŠ€æœ¯æ”¯æŒï¼ˆå¦‚éœ€è¦ï¼‰

---

ğŸ‰ **æ­å–œï¼** å®Œæˆè¿ç§»åï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªåŸºäºæœ€æ–°é£ä¹¦v1 APIçš„å¼ºå¤§ã€å®‰å…¨ã€åŠŸèƒ½å®Œæ•´çš„æ¶ˆæ¯æ¨é€ç³»ç»Ÿï¼
