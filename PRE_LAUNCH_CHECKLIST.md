# Protalk App Review Service: 上线前检查清单与部署计划

**文档版本:** 1.1  
**状态:** 审核完成  
**最后更新:** 2024年1月

## 1. 文档说明

本文档基于对 Protalk App Review Service 需求文档、架构设计和核心源代码的深入分析，制定了确保服务稳定成功上线的完整检查清单、行动计划和操作流程。

计划分为三个阶段：
- **第一阶段：关键问题修复与手动验收测试** - 解决上线阻塞问题，验证核心功能。**此阶段必须在上线前完成。**
- **第二阶段：服务冷启动与上线流程** - 安全平稳地将服务首次部署到生产环境的详细步骤。
- **第三阶段：长期质量保障体系建设** - 建立自动化测试框架，确保项目长期健康迭代。

---

## 第一阶段：关键问题修复与手动验收测试（上线前必须完成）

**目标**：解决已发现的严重缺陷，通过手动测试验证端到端用户流程的完整性。

### 任务 1.1：修复功能缺陷 - 飞书卡片回复功能

**问题说明**：当前用户在飞书交互卡片中提交的回复内容没有被正确处理，导致回复功能中断。

**修复计划**：
-   [ ] **服务层实现**：在 `src/services/ReviewSyncService.ts` 中实现 `replyToReview` 方法
    -   调用 `fetcher.replyToReview()` 提交回复到 App Store Connect API
    -   调用 `db.updateReply()` 更新数据库中的回复记录
    -   添加完整的错误处理和日志记录
-   [ ] **集成层验证**：确认 `src/services/FeishuServiceV1.ts` 中的 `handleReplyAction` 方法正确调用新实现的服务
-   [ ] **API路由完善**：修改 `src/api/feishu-routes.ts` 中的 `handleSubmitReplyV1` 函数，确保正确调用飞书服务
-   [ ] **用户反馈机制**：实现回复成功/失败后更新原始飞书卡片的机制，提供清晰的用户反馈

### 任务 1.2：修复配置问题 - 硬编码的同步间隔

**问题说明**：定时同步间隔在 `src/index.ts` 中被硬编码为 `*/10 * * * *`，不符合可配置的设计要求。

**修复计划**：
-   [ ] **配置文件更新**：将 cron 表达式移至 `config.json` 的 `sync.reviews.interval` 字段
-   [ ] **代码调整**：修改 `src/index.ts` 读取配置文件中的间隔设置

### 任务 1.3：执行端到端手动验收测试

**目标**：模拟真实业务场景，确认系统稳定性和功能完整性。

| 场景编号 | 测试用例 | 操作步骤 | 预期结果 | 状态 |
|---------|----------|----------|----------|------|
| E2E-01 | 首次同步（冷启动） | 1. 确保 `app_reviews` 表为空<br>2. 启动服务<br>3. 通过API手动触发同步 | - 所有App Store评论被成功抓取并存储到数据库<br>- 每个评论在飞书群组生成一个格式正确的交互卡片<br>- 服务日志无错误记录 | `[ ] 待测试` |
| E2E-02 | 增量同步（新评论） | 1. 完成一次成功同步后，在App Store产生新评论<br>2. 等待定时同步或手动触发 | - 仅处理新评论<br>- 飞书群组收到新评论的单个卡片<br>- 历史评论无重复推送 | `[ ] 待测试` |
| E2E-03 | 增量同步（更新评论） | 1. 完成一次成功同步后，编辑App Store中的现有评论<br>2. 等待定时同步或手动触发 | - `SmartReviewSyncService` 识别到变更<br>- 飞书发送"评论已更新"的通知卡片 | `[ ] 待测试` |
| E2E-04 | 卡片回复（成功路径） | 1. 在飞书评论卡片中输入有效回复内容<br>2. 点击"提交"按钮 | - 回复成功提交到App Store<br>- 数据库中对应评论的 `response_body` 和 `response_date` 字段被更新<br>- 飞书卡片状态更新为"已回复"，显示回复内容 | `[ ] 待测试` |
| E2E-05 | 卡片回复（失败路径） | 1. 尝试提交空的回复内容<br>2. 尝试提交超长的回复内容 | - App Store API调用优雅失败<br>- 飞书卡片更新，显示错误提示（如"回复不能为空"）<br>- 数据库无错误数据写入 | `[ ] 待测试` |
| E2E-06 | API健康检查与认证 | 1. 访问 `GET /health`<br>2. 访问 `GET /api/sync/status`<br>3. 使用错误/无效的 `X-API-Key` 调用 `POST /api/sync`<br>4. 使用正确密钥调用同步接口 | - 健康检查和状态接口返回 `200 OK` 及正确数据<br>- 无效密钥返回 `401 Unauthorized` 或 `403 Forbidden`<br>- 正确密钥成功触发同步 | `[ ] 待测试` |

---

## 第二阶段：服务冷启动与上线流程

**目标**：安全地部署服务并执行初始数据同步，避免历史数据对用户造成信息干扰。

### 上线准备步骤

1.  [ ] **步骤1：生产环境准备**
    -   在生产部署环境（如Vercel）中配置所有必需的环境变量（Supabase、App Store、飞书相关配置）
    -   准备并验证生产环境的最终 `config.json` 配置文件
    -   确认所有密钥和配置的正确性

2.  [ ] **步骤2：数据库初始化**
    -   在生产环境的Supabase实例中执行最新的数据库迁移脚本
    -   验证所有必需的表和索引已正确创建

3.  [ ] **步骤3：执行"冷启动"同步**
    
    **关键配置**：在 `config.json` 中设置以下参数以防止历史数据推送：
    ```json
    {
      "sync": {
        "reviews": {
          "pushNewReviews": false,
          "pushUpdatedReviews": false, 
          "pushHistoricalReviews": false,
          "markHistoricalAsPushed": true
        }
      },
      "features": {
        "smartPushNotifications": true
      }
    }
    ```
    
    **执行流程**：
    -   [ ] 使用上述配置部署应用程序
    -   [ ] 手动调用 `POST /api/sync` 触发首次全量同步
    -   [ ] **验证检查**：
        -   监控服务日志，确认同步过程成功完成，无错误
        -   查询生产数据库，确认所有历史评论的 `is_pushed` 字段均为 `true`
        -   确认飞书群组**没有**收到任何历史评论推送

4.  [ ] **步骤4：切换到实时模式**
    
    **配置调整**：更新 `config.json` 启用实时推送：
    ```json
    {
      "sync": {
        "reviews": {
          "pushNewReviews": true,
          "pushUpdatedReviews": true,
          "pushHistoricalReviews": false,
          "markHistoricalAsPushed": true
        }
      }
    }
    ```
    -   [ ] 重新部署应用程序
    -   [ ] **服务正式上线** - 此后只推送新增或更新的评论

5.  [ ] **步骤5：上线后监控**
    -   [ ] 持续监控服务日志，特别关注错误信息
    -   [ ] 验证新的App Store评论能够近实时地推送到飞书群组
    -   [ ] 确认回复功能正常工作

---

## 第三阶段：长期质量保障体系建设（建议实施）

**目标**：建立自动化测试安全网，降低回归风险，支持项目长期健康迭代。

### 测试体系建设路线图

-   [ ] **建议1：实施单元测试**
    -   **优先测试目标**：
        -   `src/utils/smart-push-manager.ts`：测试其复杂的推送决策逻辑
        -   `src/utils/feishu-card-v2-builder.ts`：防止生成无效的卡片结构
        -   `src/utils/jwt.ts`：确保认证令牌生成的一致性和正确性
        -   `src/utils/content-hash.ts`：验证内容变更检测算法的准确性
    -   **测试工具**：`jest`
    -   **预期收益**：确保核心工具函数在各种边界条件下的稳定性

-   [ ] **建议2：实施集成测试**
    -   **优先测试目标**：
        -   `src/services/SmartReviewSyncService.ts`：通过模拟 `IReviewFetcher` 和 `IDatabaseManager` 测试抓取、数据库检查和推送决策的交互
        -   `src/services/ReviewSyncService.ts`：验证评论同步和回复功能的端到端流程
    -   **测试工具**：`jest` 及其模拟功能
    -   **预期收益**：确保服务层逻辑的正确性，验证模块间协作

-   [ ] **建议3：实施API端到端测试**
    -   **优先测试目标**：
        -   针对专用测试数据库测试 `/api/sync` 接口
        -   通过模拟飞书请求负载测试 `/feishu/card-actions` 接口
        -   验证API认证和错误处理机制
    -   **测试工具**：`supertest`
    -   **预期收益**：从HTTP接口层面验证完整应用功能

-   [ ] **建议4：集成CI/CD流水线**
    -   在部署流水线（如GitHub Actions）中添加 `npm test` 步骤
    -   配置任何测试失败时自动阻止生产部署
    -   建立测试覆盖率报告和质量门禁
    -   **预期收益**：自动化质量保障，防止有缺陷的代码进入生产环境

### 实施时间建议

- **第一优先级**（上线后1个月内）：核心工具函数的单元测试
- **第二优先级**（上线后2个月内）：关键服务的集成测试  
- **第三优先级**（上线后3个月内）：API端到端测试和CI/CD集成

---

## 附录

### 风险评估与缓解措施

**高风险项**：
- 飞书卡片回复功能断裂：**已识别，列入第一阶段必修项**
- 缺乏自动化测试：**通过第一阶段手动测试缓解，第三阶段根本性解决**

**中风险项**：
- 配置管理不够灵活：**已列入修复计划**
- 历史数据可能造成用户干扰：**通过第二阶段冷启动策略解决**

### 成功标准

**第一阶段完成标准**：
- [ ] 所有已知功能缺陷修复完成
- [ ] 全部6个端到端测试用例通过
- [ ] 服务在测试环境稳定运行24小时无故障

**第二阶段完成标准**：
- [ ] 生产环境冷启动成功，无历史数据干扰
- [ ] 实时模式切换成功，新评论正常推送
- [ ] 生产环境稳定运行72小时

**项目上线成功标准**：
- [ ] 所有核心功能在生产环境正常工作
- [ ] 用户能够通过飞书卡片成功回复App Store评论
- [ ] 系统能够7×24小时稳定运行
- [ ] 具备基本的监控和问题排查能力

---

**文档维护**：请在执行过程中及时更新各项任务的完成状态，并记录遇到的问题和解决方案。
